<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Agendamento de Coleta - ReciclaSLA</title>
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/agendamento.css">
</head>
<body>
  <div id="sidebar-container"></div>

  <main class="content">
    <h2>üóìÔ∏è Agendamento de Coleta</h2>

    <form id="form-agendamento" class="form-agendamento">
      <div class="form-group">
        <label for="nomeRepresentante">Nome do Representante:</label>
        <input type="text" id="nomeRepresentante" required placeholder="Digite o nome do representante">
      </div>

      <div class="form-group">
        <label for="dataColeta">Data:</label>
        <input type="date" id="dataColeta" required>
      </div>

      <div class="form-group">
        <label for="horaColeta">Hora:</label>
        <input type="time" id="horaColeta" required>
      </div>

      <div class="form-group">
        <label for="cep">CEP:</label>
        <input type="text" id="cep" required placeholder="Digite seu CEP">
      </div>

      <div class="form-group">
        <button type="button" id="btnBuscarColeta">Buscar Coleta Mais Pr√≥xima</button>
      </div>

      <input type="hidden" id="cooperativaSelecionada">

      <div class="form-group">
        <button type="submit">Agendar Coleta</button>
      </div>

      <div class="ver">
        <button type="button" onclick="window.location.href='veragendamentos.html'">üìã Ver Agendamentos</button>
      </div>

      <div id="mensagemAgendamento" class="mensagem-agendamento"></div>
    </form>
  </main>

<script>
  const recyclePoints = [
    { id: 1, name: "Campo Grande", lat: -12.988572736686292, lng: -38.520103895353984 },
    { id: 2, name: "Ondina", lat: -13.0115, lng: -38.4995 },
    { id: 3, name: "Rio Vermelho", lat: -13.0102, lng: -38.4866 },
    { id: 4, name: "Brotas", lat: -12.985138018320063, lng: -38.501248250615475 },
    { id: 5, name: "Pituba", lat: -13.000812913502605, lng: -38.45969249204836 },
    { id: 6, name: "Pernambu√©s", lat: -12.972252437839018, lng: -38.461392333116734 },
    { id: 7, name: "Imbu√≠", lat: -12.970897156797012, lng: -38.43489105185892 },
    { id: 8, name: "Sussuarana", lat: -12.933550563139878, lng: -38.444129692500596 },
    { id: 9, name: "S√£o Crist√≥v√£o", lat: -12.91040561999883, lng: -38.353779377995345 },
    { id: 10, name: "Cajazeiras", lat: -12.899468912209896, lng: -38.4077516879381 }
  ];

  function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  async function buscarCoordenadasPorCEP(cep) {
    const viaCepResp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
    const viaCepData = await viaCepResp.json();

    if (viaCepData.erro) {
      throw new Error("CEP n√£o encontrado no ViaCEP.");
    }

    const tentativas = [
      `${viaCepData.logradouro}, ${viaCepData.bairro}, ${viaCepData.localidade}, ${viaCepData.uf}, Brasil`,
      `${viaCepData.bairro}, ${viaCepData.localidade}, ${viaCepData.uf}, Brasil`,
      `${viaCepData.localidade}, ${viaCepData.uf}, Brasil`
    ];

    for (const endereco of tentativas) {
      const nominatimResp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`);
      const nominatimData = await nominatimResp.json();

      if (nominatimData.length > 0) {
        return {
          lat: parseFloat(nominatimData[0].lat),
          lng: parseFloat(nominatimData[0].lon)
        };
      }
    }

    throw new Error("Coordenadas n√£o encontradas para esse CEP.");
  }

  document.getElementById('btnBuscarColeta').addEventListener('click', async function () {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    const mensagemDiv = document.getElementById('mensagemAgendamento');

    if (cep.length !== 8) {
      alert("CEP inv√°lido. Digite um CEP com 8 n√∫meros.");
      return;
    }

    mensagemDiv.textContent = "Buscando cooperativa mais pr√≥xima...";
    mensagemDiv.style.color = "black";

    try {
      const { lat, lng } = await buscarCoordenadasPorCEP(cep);
      let menorDistancia = Infinity;
      let pontoMaisProximo = null;

      for (const ponto of recyclePoints) {
        const distancia = calcularDistancia(lat, lng, ponto.lat, ponto.lng);
        if (distancia < menorDistancia) {
          menorDistancia = distancia;
          pontoMaisProximo = ponto;
        }
      }

      if (pontoMaisProximo) {
        document.getElementById('cooperativaSelecionada').value = pontoMaisProximo.name;
        mensagemDiv.innerHTML = `‚ôªÔ∏è Cooperativa mais pr√≥xima: <strong>${pontoMaisProximo.name}</strong><br>Dist√¢ncia estimada: <strong>${menorDistancia.toFixed(2)} km</strong>`;
        mensagemDiv.style.color = "blue";
      } else {
        mensagemDiv.textContent = "Nenhum ponto de coleta encontrado.";
        mensagemDiv.style.color = "red";
      }
    } catch (err) {
      mensagemDiv.textContent = "Erro ao buscar CEP: " + err.message;
      mensagemDiv.style.color = "red";
    }
  });

  document.getElementById('form-agendamento').addEventListener('submit', async function (e) {
    e.preventDefault();

    const email = localStorage.getItem('usuarioLogado');
    const mensagemDiv = document.getElementById('mensagemAgendamento');

    if (!email) {
      alert("Usu√°rio n√£o est√° logado.");
      return;
    }

    const nome = document.getElementById('nomeRepresentante').value;
    const data = document.getElementById('dataColeta').value;
    const hora = document.getElementById('horaColeta').value;
    const cep = document.getElementById('cep').value;
    const cooperativa = document.getElementById('cooperativaSelecionada').value;

    if (!cooperativa) {
      alert("Por favor, clique em 'Buscar Coleta Mais Pr√≥xima' antes de agendar.");
      return;
    }

    const resposta = await fetch(`/api/agendar/${email}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nome, data, hora, cep, cooperativa })
    });

    const resultado = await resposta.json();

    if (resposta.ok) {
      mensagemDiv.textContent = "‚úÖ Agendamento conclu√≠do!";
      mensagemDiv.style.color = "green";
      document.getElementById('form-agendamento').reset();
      document.getElementById('cooperativaSelecionada').value = '';
    } else {
      mensagemDiv.textContent = "‚ùå Erro ao agendar: " + resultado.message;
      mensagemDiv.style.color = "red";
    }
  });

  fetch("sidebar.html")
    .then(response => response.text())
    .then(data => {
      document.getElementById("sidebar-container").innerHTML = data;
    });
</script>

</body>
</html>
